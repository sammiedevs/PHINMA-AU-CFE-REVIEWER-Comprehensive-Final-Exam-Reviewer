<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <title>Subject Details</title>
</head>
<style>
    body {
        background: #eee;
    }
    #subjectDetails{
    	display: block;
    }
    .subject-details {
        width: 100%; /* Make the list take up full width */
        display: flex;
        flex-direction: column; /* Stack items vertically */
        gap: 5px; /* Space between items */
        padding: 10px;
        display: block;
    }

    .subject-button {
    display: flex; /* Use flex to align items in a row */
    justify-content: space-between; /* Pushes name left, menu right */
    align-items: center; /* Aligns vertically */
    width: 100%;
    background: #f0f0f0;
    padding: 15px 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s, transform 0.3s, box-shadow 0.3s;
    margin-bottom: 5px;
}

    .subject-button:hover {
        background: #161041;
        transform: translateY(-2px); /* Slight lift on hover */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Add shadow on hover */
    }
    .subject-button:hover .subject-name {
        color: white; /* Change text color to white on hover */
    }
    .subject-button:hover .menu-button{
            color:white;
    }

    .subject-button .subject-name {
        font-size: 18px;
        font-weight: 500;
        color: #161041; /* Dark blue for subject name */
        display: flex;
        align-items: center;
        gap: 10px; /* Space between icon and text */
    }

    .subject-button .subject-name i {
        font-size: 20px; /* Icon size */
        color: #F59D37; /* Icon color */
    }
    
    

    .add-subject-button {
        position: relative;
        width: 150px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        border: 1px solid #34974d;
        background-color: #3aa856;
        overflow: hidden; /* Ensure the icon doesn't overflow */
        padding-left: 10px; /* Add left padding to align text */
        padding-right: 10px;
    }

    .add-subject-button, .button__icon, .button__text {
        transition: all 0.3s;
    }

    .add-subject-button .button__text {
        color: #fff;
        font-weight: 600;
        text-align: left; /* Align text to the left */
        flex-grow: 1; /* Allow text to take up remaining space */
    }

    .add-subject-button .button__icon {
        position: absolute;
        right: 0; /* Position icon on the right */
        height: 100%;
        width: 39px;
        background-color: #34974d;
        display: flex;
        align-items: center;
        justify-content: center;
        transform: translateX(calc(100% - 30px)); /* Partially show the icon */
    }

    .add-subject-button .svg {
        width: 30px;
        stroke: #fff;
        padding-right: 10px;
    }

    .add-subject-button:hover {
        background: #34974d;
    }

    .add-subject-button:hover .button__text {
        color: transparent; /* Hide text on hover */
    }

    .add-subject-button:hover .button__icon {
        width: 100%; /* Expand icon to full width on hover */
        transform: translateX(0); /* Move icon to the left */
    }

    .add-subject-button:active .button__icon {
        background-color: #2e8644; /* Change icon background on active */
    }

    .add-subject-button:active {
        border: 1px solid #2e8644; /* Change border color on active */
    }

    .data {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        margin: 100px 50px;
    }

    .page {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #F59D37;
        margin-bottom: 10px;
        padding-bottom: 10px;
    }
    .page button {
        margin-bottom: 10px;
        font-size: 14px;
    }

    .page h1 {
        font-size: 35px;
        color: #161041;
        margin: 0;
    }
    a{
    	text-decoration:none;
    }
    .no-reviewers {
    color: gray;
    text-align: center;
    font-style: italic;
    font-size: 16px;
    margin-top: 10px;
}
    .subject-container {
    display: block; /* Ensures subjects are grouped */
}
	.subject-container:empty {
    display: none;
}
        
/* Menu container to position the dropdown */
.menu-container {
    position: relative;
    display: flex;
    align-items: center;
}

/* Three-dots button */
.menu-button {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
    margin-left: 10px;
    color: #161041;
}

/* Dropdown menu */
.menu-dropdown {
    display: none;
    position: absolute;
    top: 30px;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-radius: 10px;
    z-index: 10;
    min-width: 100px;
}

/* Buttons inside the dropdown */
.menu-dropdown button {
    width: 100%;
    padding: 8px 12px;
    border: none;
    background: none;
    cursor: pointer;
    text-align: left;
    font-size: 14px;
    border-radius: 10px;
}

.menu-dropdown button:hover {
    background: #F59D37;
    color: white;
}
.menu-dropdown button.del:hover{
    background:#AA4A44;
}
.no-reviewers {
    color: gray;
    text-align: center;
    font-style: italic;
    font-size: 16px;
    margin-top: 10px;
}




</style>
<body>
                
       		<a href="copy_notes.html">
				<img style="margin-top: 20px; margin-left: 20px; cursor: pointer;" src="img/back.png">
        	</a>
        
            <div class="data">
            	<div class="page">
                <h1>Reviewer Notes</h1>

                <button class="add-subject-button" onclick="openModal()">
                    <span class="button__text">Add Reviewer</span>
                    <span class="button__icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" stroke="currentColor" height="24" fill="none" class="svg">
                            <line y2="19" y1="5" x2="12" x1="12"></line>
                            <line y2="12" y1="12" x2="19" x1="5"></line>
                        </svg>
                    </span>
                </button>

            </div>
            
            <div class="subject-details" id="subjectDetails">
            	<!-- Titles will be dynamically added here -->
            	<p style="color: gray;">Loading...</p>
        	</div>
            </div>
            
        </main>
    </section>

    <!-- Notification Modal -->
    <div id="notif-modal" class="notif">
        <div class="notif-content">
            <div class="close-button">
            	<img src="img/back-button.png">
        	</div>
            <h2>Notifications</h2>
            
            <!-- Study Reminders Section -->
            <h3>Study Reminders</h3>
            <ul id="study-reminders">
                <!-- Study reminders will be dynamically added here -->
            </ul>

            <!-- Exam Updates Section -->
            <h3>Exam Updates</h3>
            <ul id="exam-updates">
                <!-- Exam updates will be dynamically added here -->
            </ul>
        </div>
    </div>
        
     <!-- Profile Modal -->
<div class="container" id="profile-popup">
    <div class="box form-box" id="popup">
        <div class="close-button">
            <img src="img/back-button.png">
        </div>
        <header>PROFILE</header>
        <div class="profile-info">
            <div class="field">
                <label for="userfullname">Full Name</label>
                <p id="userfullname">Loading...</p>
            </div>
            <div class="field">
                <label for="username">Username</label>
                <p id="username">Loading...</p>
            </div>
            <div class="field">
                <label for="useremail">Email</label>
                <p id="useremail">Loading...</p>
            </div>
            <div class="field">
                <label for="userphone">Phone Number</label>
                <p id="userphone">Loading...</p>
            </div>
        </div>
        <div class="field">
            <button class="fbtn" id="edit-profile-btn">Edit Profile</button>
        </div>
    </div>
</div>
        
    <!-- Modal for Adding Subject -->
<div class="container" id="addReviewerModal">
    <div class="box form-box" id="popup">
        <div class="close-button" onclick="closeModal()">
            <img src="img/back-button.png">
        </div>
        <header>Add Subject</header>
        <form id="subject-form">
            <input type="hidden" id="userId" name="user_id">
            <div class="field input">
                <label for="titleTitle">Subject</label>
                <input type="text" name="subject" id="titleTitle" placeholder="Enter subject here" autocomplete="off" required>
            </div>
            <div class="field">
                <input type="submit" class="fbtn" name="submit" value="Submit" required>
            </div>
        </form>
    </div>
</div>
        
<div id="updateTitleModal" class="container" style="display: none;">
    <div class="box form-box" id="popup">
        <div class="close-button" onclick="closeUpdateModal()">
            <img src="img/back-button.png">
        </div>
        <header>Update Title</header>
        <form id="update-title-form">
            <div class="field input">
                <label for="updateTitleName">Title Name</label>
                <input type="text" id="updateTitleName" placeholder="Enter new title name here" required>
            </div>
            <div class="field">
                <input type="hidden" id="updateTitleId">
                <button type="submit" class="fbtn">Update</button>
            </div>
        </form>
    </div>
</div>

    <script src="notif.js"></script>
    <script src="fetch_profile.js"></script>
        
    <script>
    document.addEventListener("DOMContentLoaded", function () {
    fetchSubjectTitles();

    // Add event listener for the add form submission
    document.getElementById("subject-form").addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent the default form submission
        addTitle(); // Call the addTitle function
    });

    // Add event listener for the update form submission
    document.getElementById("update-title-form").addEventListener("submit", function (event) {
        event.preventDefault();
        updateTitle();
    });
});

function fetchSubjectTitles() {
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");

    if (!id) {
        console.error("ID not found in the URL");
        return;
    }

    console.log("Fetching titles for subject ID:", id); // Debug: Log the subject ID
    const fetchUrl = `subject_details.php?action=view&id=${encodeURIComponent(id)}`;
    console.log("Fetching from:", fetchUrl); // Debug: Log the fetch URL

    fetch(fetchUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.text();
        })
        .then(text => {
            console.log("Raw response from server:", text); // Debug: Log the raw response

            try {
                const data = JSON.parse(text);
                console.log("Parsed data:", data); // Debug: Log the parsed data

                let subjectDetails = document.getElementById("subjectDetails");
                if (!subjectDetails) {
                    console.error("subjectDetails container not found!");
                    return;
                }

                subjectDetails.innerHTML = ""; // Clear the container

                if (data.error) {
                    console.error("Error fetching titles:", data.error);
                    subjectDetails.innerHTML = `<p class="error">${data.error}</p>`;
                    return;
                }

                console.log("Data success:", data.success); // Debug: Log data.success
                console.log("Titles array:", data.titles); // Debug: Log data.titles

                // Filter out titles with null or empty title values
                const validTitles = data.titles.filter(title => title.title && title.title.trim() !== "");

                console.log("Valid titles:", validTitles); // Debug: Log valid titles

                if (!data.success || !Array.isArray(data.titles) || validTitles.length === 0) {
                    // Display "No reviewers added for this subject yet" message
                    let noTitlesMessage = document.createElement("p");
                    noTitlesMessage.className = "no-reviewers";
                    noTitlesMessage.textContent = "No reviewers added for this subject yet.";
                    subjectDetails.appendChild(noTitlesMessage);
                } else {
                    validTitles.forEach(title => {
                        // Create the subject-button div
                        let subjectButton = document.createElement("div");
                        subjectButton.className = "subject-button"; // Add CSS class

                        // Create the title name span
                        let titleName = document.createElement("span");
                        titleName.className = "subject-name"; // Add CSS class
                        titleName.textContent = title.title;

                        // Create menu container
                        let menuContainer = document.createElement("div");
                        menuContainer.className = "menu-container";

                        // Three-dots button
                        let menuButton = document.createElement("button");
                        menuButton.className = "menu-button";
                        menuButton.innerHTML = "&#x22EE;"; // Unicode for vertical dots
                        menuButton.onclick = (event) => {
                            event.stopPropagation(); // Prevent parent click event
                            toggleMenu(menuContainer);
                        };

                        // Dropdown menu
                        let menuDropdown = document.createElement("div");
                        menuDropdown.className = "menu-dropdown";
                        menuDropdown.innerHTML = `
                            <button class="update-btn" data-id="${title.id}">Update</button>
                            <button class="del" data-id="${title.id}">Delete</button>
                        `;

                        // Append menu button and dropdown to the menu container
                        menuContainer.appendChild(menuButton);
                        menuContainer.appendChild(menuDropdown);

                        // Append the title name and menu container to the subject-button div
                        subjectButton.appendChild(titleName);
                        subjectButton.appendChild(menuContainer);

                        // Add event listeners for Update and Delete buttons
                        menuDropdown.querySelector(".update-btn").addEventListener("click", (event) => {
                            event.stopPropagation(); // Stop click from triggering parent event
                            fetchTitleForUpdate(event.target.dataset.id);
                        });

                        menuDropdown.querySelector(".del").addEventListener("click", (event) => {
                            event.stopPropagation(); // Stop click from triggering parent event
                            deleteTitle(event.target.dataset.id);
                        });

                        // Add click event listener to the subject-button div
                        subjectButton.addEventListener("click", (event) => {
                            // Only navigate if the subject button itself is clicked (not the menu or its buttons)
                            if (!event.target.closest(".menu-container")) {
                                window.location.href = `copy_content.html?id=${title.id}`;
                            }
                        });

                        // Append the subject-button div to the subjectDetails container
                        subjectDetails.appendChild(subjectButton);
                    });
                }
            } catch (error) {
                console.error("Failed to parse JSON:", error);
                console.error("Raw response that caused the error:", text);
                document.getElementById("subjectDetails").innerHTML = `<p class="error">Invalid response from the server. Please try again later.</p>`;
            }
        })
        .catch(error => {
            console.error("Error fetching titles:", error);
            document.getElementById("subjectDetails").innerHTML = `<p class="error">Failed to load titles. Please try again later.</p>`;
        });
}
            
            
            
// Function to toggle menu visibility
function toggleMenu(menu) {
    document.querySelectorAll(".menu-dropdown").forEach(dropdown => {
        if (dropdown !== menu.querySelector(".menu-dropdown")) {
            dropdown.style.display = "none"; // Hide other menus
        }
    });

    let dropdown = menu.querySelector(".menu-dropdown");
    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
}

// Close menu when clicking outside
document.addEventListener("click", () => {
    document.querySelectorAll(".menu-dropdown").forEach(dropdown => {
        dropdown.style.display = "none";
    });
});

// Open the add modal
function openModal() {
    document.getElementById("addReviewerModal").style.display = "flex";
}

// Close the add modal
function closeModal() {
    document.getElementById("addReviewerModal").style.display = "none";
}

// Add a new title
function addTitle() {
    const title = document.getElementById("titleTitle").value.trim();
    const urlParams = new URLSearchParams(window.location.search);
    const subjectId = urlParams.get("id"); // Get the subject ID from the URL

    if (!title) {
        alert("Title cannot be empty.");
        return;
    }

    if (!subjectId) {
        alert("Subject ID not found in the URL.");
        return;
    }

    // Send title and subject ID to the database
    fetch("subject_details.php?action=add", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `title=${encodeURIComponent(title)}&subject_id=${encodeURIComponent(subjectId)}` // Send subject_id
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Title added successfully!");
                closeModal();
                fetchSubjectTitles(); // Refresh the title list
            } else {
                alert("Error: " + data.error);
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("An error occurred while adding the title.");
        });
}

// Fetch a title for updating
function fetchTitleForUpdate(titleId) {
    fetch(`get_title.php?id=${titleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById("updateTitleId").value = data.title.id; // Set the hidden input for title ID
                document.getElementById("updateTitleName").value = data.title.title; // Set the input field for title name
                document.getElementById("updateTitleModal").style.display = "flex"; // Show the modal
            } else {
                alert("Failed to fetch title: " + (data.error || "Unknown error"));
            }
        })
        .catch(error => console.error("Error fetching title:", error));
}

// Update a title
function updateTitle() {
    const titleId = document.getElementById("updateTitleId").value;
    const titleName = document.getElementById("updateTitleName").value.trim();

    if (!titleName) {
        alert("Title name cannot be empty.");
        return;
    }

    // Send update request via AJAX
    fetch("subject_details.php?action=update", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `title_id=${encodeURIComponent(titleId)}&title_name=${encodeURIComponent(titleName)}`
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Title updated successfully!");
                closeUpdateModal();
                fetchSubjectTitles(); // Refresh the title list
            } else {
                alert("Update failed: " + (data.error || "Unknown error"));
            }
        })
        .catch(error => {
            console.error("Error updating title:", error);
            alert("An error occurred while updating the title.");
        });
}

// Close the update modal
function closeUpdateModal() {
    document.getElementById("updateTitleModal").style.display = "none";
}

// Delete a title
function deleteTitle(id) {
    if (confirm("Are you sure you want to delete this title?")) {
        console.log("Deleting title with ID:", id); // Debug: Log the ID being deleted
        fetch("subject_details.php?action=delete", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `id=${id}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Title deleted successfully!");
                    fetchSubjectTitles(); // Refresh the title list
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(error => console.error("Error deleting title:", error));
    }
}
    </script>
</body>
</html>